USE [<%= @database %>];
DECLARE @perm_state varchar(250);
SET @perm_state = ISNULL(
	(SELECT perm.state_desc FROM sys.database_principals princ
		JOIN sys.database_permissions perm ON perm.grantee_principal_id = princ.principal_id
		WHERE princ.type in ('U','S','G') AND name = '<%= @user %>' AND permission_name = '<%= @_permission %>' ),
		'REVOKE');
DECLARE @error_msg varchar(250);
SET @error_msg = 'EXPECTED user [<%= @user %>] to have permission [<%= @_permission %>] with <%= @_state %> but got ' + @perm_state;
IF @perm_state != '<%= @_state %>'
	THROW 51000, @error_msg, 10
