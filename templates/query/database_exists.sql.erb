-- QUICK CHECK before most costly query
IF <% if @ensure == 'present' %>NOT<% end %> EXISTS(SELECT name from sys.databases WHERE name = '<%= @db_name %>')
BEGIN
    THROW 51000, 'ERROR The database does not exist', 10
END

DECLARE @cmptlevel as Int

IF <% if @ensure == 'present' %>NOT<% end %> EXISTS(
SELECT count(*)
    FROM sys.sysdatabases sd
LEFT JOIN sys.databases d ON d.database_id = sd.dbid
LEFT JOIN sys.database_filestream_options fs ON fs.database_id = sd.dbid
WHERE d.name = '<%= @db_name %>'
    AND d.cmptlevel = <%= @compatibility %> )
    <% if @collation_name %>
    AND d.collation_name = '<%= @collation_name %>'
    <% end %>
BEGIN
   BEGIN TRY
		THROW 51000, 'ERROR The database does not exists', 10
	END TRY
	BEGIN CATCH
		THROW;
	END CATCH
END
